import React, { useState, useEffect } from 'react';
import { 
  ArrowLeft, 
  Star, 
  ChevronDown,
  Camera,
  X,
  Gift,
  Upload,
  Check,
  Users,
  Plus
} from 'lucide-react';

const GuideReviewTemplate2 = ({ onBack }) => {
  // Pretendard Ìè∞Ìä∏ Î°úÎìú
  useEffect(() => {
    const link = document.createElement('link');
    link.href = 'https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard.css';
    link.rel = 'stylesheet';
    document.head.appendChild(link);

    document.body.style.fontFamily = '"Pretendard Variable", Pretendard, -apple-system, BlinkMacSystemFont, system-ui, Roboto, "Helvetica Neue", "Segoe UI", "Apple SD Gothic Neo", "Noto Sans KR", "Malgun Gothic", sans-serif';

    return () => {
      if (document.head.contains(link)) {
        document.head.removeChild(link);
      }
    };
  }, []);

  const [rating, setRating] = useState(0);
  const [showRatingDropdown, setShowRatingDropdown] = useState(false);
  const [selectedOptions, setSelectedOptions] = useState({});
  const [uploadedImages, setUploadedImages] = useState([]);
  const [reviewText, setReviewText] = useState('');

  const ratingLabels = {
    1: 'ÏïÑÏâ¨ÏõåÏöî',
    2: 'Í∑∏Ï†Ä Í∑∏ÎûòÏöî',
    3: 'Î≥¥ÌÜµÏù¥ÏóêÏöî',
    4: 'Ï¢ãÏïÑÏöî',
    5: 'ÏµúÍ≥†ÏòàÏöî'
  };

  const evaluationCategories = [
    {
      title: 'Í∞ÄÏù¥Îìú Ï†ÑÎ¨∏ÏÑ±',
      options: [
        { text: 'ÍπäÏù¥ ÏûàÎäî ÏßÄÏãùÏùÑ Ï†ÑÎã¨Ìï¥Ï§¨Ïñ¥Ïöî', icon: 'üéì', count: 100 },
        { text: 'ÌòÑÏßÄ Î¨∏Ìôî/Ïó≠ÏÇ¨Ïóê ÎåÄÌïú Ïù¥Ìï¥Í∞Ä ÎÜíÏïÑÏöî', icon: 'üèõÔ∏è', count: 68 },
        { text: 'ÏßàÎ¨∏Ïóê Ï†ïÌôïÌïòÍ≤å ÎãµÎ≥ÄÌï¥Ï§¨Ïñ¥Ïöî', icon: 'üí°', count: 49 },
        { text: 'ÏµúÏã† Ï†ïÎ≥¥ÏôÄ Ìä∏Î†åÎìúÎ•º Ïûò ÏïåÍ≥† ÏûàÏñ¥Ïöî', icon: 'üì±', count: 5 }
      ]
    },
    {
      title: 'ÏπúÏ†àÌï®',
      options: [
        { text: 'Ìï≠ÏÉÅ Î∞ùÍ≤å ÏùëÎåÄÌñàÏñ¥Ïöî', icon: 'üòä', count: 89 },
        { text: 'ÏöîÏ≤≠ ÏÇ¨Ìï≠ÏùÑ Ïûò Îì§Ïñ¥Ï§¨Ïñ¥Ïöî', icon: 'üëÇ', count: 72 },
        { text: 'Î∞∞Î†§Ïã¨Ïù¥ ÎäêÍª¥Ï°åÏñ¥Ïöî', icon: 'üíù', count: 56 },
        { text: 'Î∂àÌé∏Ìï® ÏóÜÏù¥ Ìé∏ÏïàÌïòÍ≤å Ìï¥Ï§¨Ïñ¥Ïöî', icon: 'ü§ó', count: 43 }
      ]
    },
    {
      title: 'Ìà¨Ïñ¥ Íµ¨ÏÑ±',
      options: [
        { text: 'ÎèôÏÑ†Ïù¥ Ìö®Ïú®Ï†ÅÏù¥ÏóàÏñ¥Ïöî', icon: 'üó∫Ô∏è', count: 95 },
        { text: 'ÏùºÏ†ïÏù¥ ÏïåÏ∞®Í≥† Ï≤¥Í≥ÑÏ†ÅÏù¥ÏóàÏñ¥Ïöî', icon: 'üìã', count: 81 },
        { text: 'Îã§ÏñëÌïú Í≤ΩÌóòÏùÑ Ìï† Ïàò ÏûàÏóàÏñ¥Ïöî', icon: 'üé≠', count: 67 },
        { text: 'ÏòàÏÉÅÏπò Î™ªÌïú Ï¶êÍ±∞ÏõÄÏù¥ ÏûàÏóàÏñ¥Ïöî', icon: 'üéâ', count: 34 }
      ]
    },
    {
      title: 'ÎèôÎ∞òÏù∏',
      options: [
        { text: 'Í∞ÄÏ°±Í≥º Ìï®Íªò', icon: 'üë®‚Äçüë©‚Äçüëß‚Äçüë¶', count: 156 },
        { text: 'Ïó∞Ïù∏/Î∞∞Ïö∞ÏûêÏôÄ Ìï®Íªò', icon: 'üíë', count: 98 },
        { text: 'ÏπúÍµ¨/ÏßÄÏù∏Í≥º Ìï®Íªò', icon: 'üë´', count: 87 },
        { text: 'ÌòºÏûê Ï∞∏Ïó¨', icon: 'üö∂', count: 23 }
      ]
    }
  ];

  const handleOptionToggle = (categoryIndex, optionIndex) => {
    const key = `${categoryIndex}-${optionIndex}`;
    setSelectedOptions(prev => ({
      ...prev,
      [key]: !prev[key]
    }));
  };

  const handleImageUpload = (event) => {
    const files = Array.from(event.target.files);
    if (uploadedImages.length + files.length > 3) {
      alert('ÏµúÎåÄ 3Ïû•ÍπåÏßÄ ÏóÖÎ°úÎìú Í∞ÄÎä•Ìï©ÎãàÎã§.');
      return;
    }

    files.forEach(file => {
      const reader = new FileReader();
      reader.onload = (e) => {
        setUploadedImages(prev => [...prev, {
          id: Date.now() + Math.random(),
          url: e.target.result,
          file
        }]);
      };
      reader.readAsDataURL(file);
    });
  };

  const removeImage = (imageId) => {
    setUploadedImages(prev => prev.filter(img => img.id !== imageId));
  };

  const handleSubmit = () => {
    const selectedCount = Object.values(selectedOptions).filter(Boolean).length;
    const hasImages = uploadedImages.length > 0;
    
    console.log('Î¶¨Î∑∞ Îç∞Ïù¥ÌÑ∞:', {
      rating,
      selectedOptions,
      reviewText,
      images: uploadedImages,
      mileage: hasImages ? 1500 : 1000
    });
    
    alert(`Î¶¨Î∑∞Í∞Ä Îì±Î°ùÎêòÏóàÏäµÎãàÎã§! ${hasImages ? '1,500' : '1,000'} ÎßàÏùºÎ¶¨ÏßÄÍ∞Ä Ï†ÅÎ¶ΩÎê©ÎãàÎã§.`);
  };

  const mileageAmount = uploadedImages.length > 0 ? 1500 : 1000;

  return (
    <div 
      className="min-h-screen bg-gray-50"
      style={{ fontFamily: '"Pretendard Variable", Pretendard, -apple-system, BlinkMacSystemFont, system-ui, sans-serif' }}
    >
      {/* Header */}
      <div className="bg-white border-b border-gray-100">
        <div className="max-w-lg mx-auto px-6 py-4">
          <div className="flex items-center justify-between">
            <button onClick={onBack} className="p-2 hover:bg-gray-100 rounded-xl transition-colors">
              <ArrowLeft size={20} className="text-gray-600" />
            </button>
            <h1 className="text-lg font-medium text-gray-900" style={{ fontWeight: 500 }}>Í∞ÄÏù¥Îìú Î¶¨Î∑∞</h1>
            <div className="w-8"></div>
          </div>
        </div>
      </div>

      <div className="max-w-lg mx-auto px-6 py-6 space-y-6">
        {/* Î≥ÑÏ†ê ÌèâÍ∞Ä ÏÑπÏÖò */}
        <div className="bg-white rounded-3xl p-6 shadow-sm">
          <h2 className="text-xl font-semibold text-gray-900 mb-6 text-center" style={{ fontWeight: 600 }}>
            ÌôçÍ∏∏Îèô Í∞ÄÏù¥ÎìúÏôÄ Ìï®ÍªòÌïú Ïó¨ÌñâÏùÄ Ïñ¥Îñ†ÏÖ®ÎÇòÏöî?
          </h2>

          {rating === 0 ? (
            <div className="relative">
              <button
                onClick={() => setShowRatingDropdown(!showRatingDropdown)}
                className="w-full py-4 px-4 bg-gray-50 rounded-2xl flex items-center justify-between text-gray-500 hover:bg-gray-100 transition-colors"
              >
                <span style={{ fontWeight: 400 }}>ÌèâÏ†êÏùÑ ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî</span>
                <ChevronDown size={20} className={`transition-transform ${showRatingDropdown ? 'rotate-180' : ''}`} />
              </button>

              {showRatingDropdown && (
                <div className="absolute top-full left-0 right-0 mt-2 bg-white rounded-2xl shadow-lg border border-gray-100 overflow-hidden z-10">
                  {[1, 2, 3, 4, 5].map((star) => (
                    <button
                      key={star}
                      onClick={() => {
                        setRating(star);
                        setShowRatingDropdown(false);
                      }}
                      className="w-full py-4 px-4 flex items-center space-x-3 hover:bg-gray-50 transition-colors border-b border-gray-50 last:border-b-0"
                    >
                      <div className="flex">
                        {[...Array(5)].map((_, i) => (
                          <Star
                            key={i}
                            size={16}
                            className={i < star ? 'text-yellow-400 fill-current' : 'text-gray-300'}
                          />
                        ))}
                      </div>
                      <span className="text-gray-900" style={{ fontWeight: 400 }}>{ratingLabels[star]}</span>
                    </button>
                  ))}
                </div>
              )}
            </div>
          ) : (
            <div className="relative">
              <button
                onClick={() => setShowRatingDropdown(!showRatingDropdown)}
                className="w-full py-4 px-4 bg-blue-50 border border-blue-200 rounded-2xl flex items-center justify-between text-blue-700 hover:bg-blue-100 transition-colors"
              >
                <div className="flex items-center space-x-3">
                  <div className="flex">
                    {[...Array(5)].map((_, i) => (
                      <Star
                        key={i}
                        size={16}
                        className={i < rating ? 'text-yellow-400 fill-current' : 'text-gray-300'}
                      />
                    ))}
                  </div>
                  <span style={{ fontWeight: 500 }}>{ratingLabels[rating]}</span>
                </div>
                <ChevronDown size={20} className={`transition-transform ${showRatingDropdown ? 'rotate-180' : ''}`} />
              </button>

              {showRatingDropdown && (
                <div className="absolute top-full left-0 right-0 mt-2 bg-white rounded-2xl shadow-lg border border-gray-100 overflow-hidden z-10">
                  {[1, 2, 3, 4, 5].map((star) => (
                    <button
                      key={star}
                      onClick={() => {
                        setRating(star);
                        setShowRatingDropdown(false);
                      }}
                      className="w-full py-4 px-4 flex items-center space-x-3 hover:bg-gray-50 transition-colors border-b border-gray-50 last:border-b-0"
                    >
                      <div className="flex">
                        {[...Array(5)].map((_, i) => (
                          <Star
                            key={i}
                            size={16}
                            className={i < star ? 'text-yellow-400 fill-current' : 'text-gray-300'}
                          />
                        ))}
                      </div>
                      <span className="text-gray-900" style={{ fontWeight: 400 }}>{ratingLabels[star]}</span>
                    </button>
                  ))}
                </div>
              )}
            </div>
          )}
        </div>

        {/* ÌèâÍ∞Ä Ìï≠Î™©Îì§ */}
        {rating > 0 && (
          <>
            {evaluationCategories.map((category, categoryIndex) => (
              <div key={categoryIndex} className="bg-white rounded-3xl p-6 shadow-sm">
                <h3 className="text-lg font-bold text-gray-900 mb-6" style={{ fontWeight: 700 }}>
                  {category.title}
                </h3>
                <div className="space-y-3">
                  {category.options.map((option, optionIndex) => {
                    const isSelected = selectedOptions[`${categoryIndex}-${optionIndex}`];
                    return (
                      <button
                        key={optionIndex}
                        onClick={() => handleOptionToggle(categoryIndex, optionIndex)}
                        className={`w-full p-4 rounded-2xl border transition-all text-left ${
                          isSelected 
                            ? 'border-blue-500 bg-blue-50 shadow-sm' 
                            : 'border-gray-100 hover:border-gray-200 bg-white hover:shadow-sm'
                        }`}
                      >
                        <div className="flex items-center justify-between">
                          <div className="flex items-center space-x-3">
                            <span className="text-lg">{option.icon}</span>
                            <span className={`${isSelected ? 'text-blue-700' : 'text-gray-900'}`} style={{ fontWeight: 500 }}>
                              {option.text}
                            </span>
                          </div>
                          <div className="flex items-center space-x-2">
                            <div className="flex items-center space-x-1">
                              <Users size={14} className="text-gray-400" />
                              <span className="text-sm text-gray-500" style={{ fontWeight: 400 }}>{option.count}</span>
                            </div>
                            {isSelected && (
                              <div className="w-5 h-5 bg-blue-500 rounded-full flex items-center justify-center">
                                <Check size={12} className="text-white" />
                              </div>
                            )}
                          </div>
                        </div>
                      </button>
                    );
                  })}
                </div>
              </div>
            ))}

            {/* ÏÇ¨ÏßÑ ÏóÖÎ°úÎìú ÏÑπÏÖò */}
            <div className="bg-white rounded-3xl p-6 shadow-sm">
              <h3 className="text-lg font-bold text-gray-900 mb-6" style={{ fontWeight: 700 }}>
                ÏÇ¨ÏßÑ Ï∂îÍ∞Ä (ÏµúÎåÄ 3Ïû•)
              </h3>
              
              <div className="grid grid-cols-3 gap-4">
                {/* ÏóÖÎ°úÎìúÎêú Ïù¥ÎØ∏ÏßÄÎì§ */}
                {uploadedImages.map((image, index) => (
                  <div key={image.id} className="relative aspect-square">
                    <div className="w-full h-full border-2 border-gray-100 rounded-2xl overflow-hidden bg-gray-50">
                      <img
                        src={image.url}
                        alt={`ÏóÖÎ°úÎìúÎêú Ïù¥ÎØ∏ÏßÄ ${index + 1}`}
                        className="w-full h-full object-cover"
                      />
                    </div>
                    <button
                      onClick={() => removeImage(image.id)}
                      className="absolute -top-2 -right-2 w-6 h-6 bg-red-500 text-white rounded-full flex items-center justify-center hover:bg-red-600 transition-colors shadow-lg"
                    >
                      <X size={12} />
                    </button>
                  </div>
                ))}

                {/* Ï∂îÍ∞Ä ÏóÖÎ°úÎìú Î≤ÑÌäºÎì§ */}
                {Array.from({ length: 3 - uploadedImages.length }).map((_, index) => (
                  <label key={`upload-${index}`} className="aspect-square cursor-pointer">
                    <input
                      type="file"
                      accept="image/*"
                      onChange={handleImageUpload}
                      className="hidden"
                    />
                    <div className="w-full h-full border-2 border-dashed border-gray-200 rounded-2xl flex flex-col items-center justify-center text-gray-400 hover:border-gray-300 hover:bg-gray-50 transition-all bg-gray-25">
                      <Plus size={24} className="mb-1" />
                      <span className="text-xs font-medium" style={{ fontWeight: 500 }}>ÏÇ¨ÏßÑ Ï∂îÍ∞Ä</span>
                    </div>
                  </label>
                ))}
              </div>

              {uploadedImages.length > 0 && (
                <div className="mt-4 p-3 bg-blue-50 rounded-xl border border-blue-100">
                  <p className="text-sm text-blue-700 text-center" style={{ fontWeight: 500 }}>
                    üì∏ {uploadedImages.length}Ïû• ÏóÖÎ°úÎìú ÏôÑÎ£å ‚Ä¢ {3 - uploadedImages.length}Ïû• Îçî Ï∂îÍ∞Ä Í∞ÄÎä•
                  </p>
                </div>
              )}
            </div>

            {/* ÌõÑÍ∏∞ ÏûëÏÑ± ÏÑπÏÖò */}
            <div className="bg-white rounded-3xl p-6 shadow-sm">
              <h3 className="text-lg font-bold text-gray-900 mb-6" style={{ fontWeight: 700 }}>
                ÌõÑÍ∏∞ ÏûëÏÑ±
              </h3>
              <div className="border border-gray-200 rounded-2xl p-4 focus-within:border-blue-500 focus-within:ring-2 focus-within:ring-blue-50 transition-all">
                <textarea
                  value={reviewText}
                  onChange={(e) => setReviewText(e.target.value)}
                  rows={6}
                  className="w-full border-0 focus:outline-none focus:ring-0 resize-none placeholder-gray-400"
                  placeholder="Í∞ÄÏù¥ÎìúÏôÄ Ìï®ÍªòÌïú Ïó¨ÌñâÏùò ÏÜåÏ§ëÌïú Í≤ΩÌóòÏùÑ ÏûêÏú†Î°≠Í≤å Í≥µÏú†Ìï¥Ï£ºÏÑ∏Ïöî."
                  style={{ 
                    fontFamily: '"Pretendard Variable", Pretendard, sans-serif',
                    fontWeight: 400,
                    fontSize: '16px',
                    lineHeight: '1.6'
                  }}
                />
              </div>
            </div>

            {/* ÎßàÏùºÎ¶¨ÏßÄ Ï†ïÎ≥¥ */}
            <div className="bg-gradient-to-r from-blue-50 to-purple-50 rounded-3xl p-6 border border-blue-100">
              <div className="flex items-center space-x-3 mb-2">
                <Gift size={20} className="text-blue-600" />
                <h3 className="text-lg font-bold text-gray-900" style={{ fontWeight: 700 }}>ÎßàÏùºÎ¶¨ÏßÄ Ï†ÅÎ¶Ω</h3>
              </div>
              <div className="space-y-1">
                <p className="text-gray-700" style={{ fontWeight: 400 }}>
                  ‚Ä¢ Î¶¨Î∑∞Îßå ÏûëÏÑ± Ïãú <span className="font-semibold text-blue-600">1,000 ÎßàÏùºÎ¶¨ÏßÄ</span>
                </p>
                <p className="text-gray-700" style={{ fontWeight: 400 }}>
                  ‚Ä¢ Î¶¨Î∑∞ÏôÄ ÏÇ¨ÏßÑ Ìï®Íªò ÏûëÏÑ± Ïãú <span className="font-semibold text-purple-600">1,500 ÎßàÏùºÎ¶¨ÏßÄ</span> Ï†ÅÎ¶Ω!
                </p>
              </div>
              <div className="mt-4 px-4 py-2 bg-white rounded-xl border border-blue-200">
                <p className="text-center text-blue-700 font-semibold" style={{ fontWeight: 600 }}>
                  ÏòàÏÉÅ Ï†ÅÎ¶Ω: {mileageAmount.toLocaleString()} ÎßàÏùºÎ¶¨ÏßÄ
                </p>
              </div>
            </div>

            {/* Îì±Î°ù Î≤ÑÌäº */}
            <button
              onClick={handleSubmit}
              disabled={!reviewText.trim()}
              className="w-full py-4 bg-blue-600 text-white rounded-2xl hover:bg-blue-700 transition-colors font-semibold text-lg disabled:bg-gray-300 disabled:cursor-not-allowed shadow-lg"
              style={{ fontWeight: 600 }}
            >
              Í∞ÄÏù¥Îìú Î¶¨Î∑∞ Îì±Î°ù
            </button>
          </>
        )}
      </div>
    </div>
  );
};

export default GuideReviewTemplate2;